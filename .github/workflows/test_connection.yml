name: Test PostgreSQL Connection

on: [push]

jobs:
  test-connection:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:latest
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd="pg_isready -U ${{ secrets.POSTGRES_USER }}" 
          --health-interval=10s 
          --health-timeout=5s 
          --health-retries=5

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Wait for PostgreSQL to be ready
      run: sleep 30

    - name: Run SQL commands
      env:
        PGPASSWORD: postgres
      run: |
        psql -h localhost -U postgres -d testdb -c "
        CREATE TABLE IF NOT EXISTS public.agents (
            id integer NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
            agent_code character varying(150) COLLATE pg_catalog.\"default\" NOT NULL,
            agent_name character varying(128) COLLATE pg_catalog.\"default\" NOT NULL,
            working_area character varying(254) COLLATE pg_catalog.\"default\" NOT NULL,
            commission numeric(10,2),
            phone_number character varying(255) COLLATE pg_catalog.\"default\",
            country character varying(254) COLLATE pg_catalog.\"default\" NOT NULL,
            CONSTRAINT agents_pkey PRIMARY KEY (id),
            CONSTRAINT agents_code_key UNIQUE (agent_code)
        );

        INSERT INTO public.agents (agent_code, agent_name, working_area, commission, phone_number, country) VALUES 
        ('A007', 'Ramasundar', 'Bangalore', '0.15', '077-25814763', ''),
        ('A003', 'Alex', 'London', '0.13', '075-12458969', ''),
        ('A008', 'Alford', 'New York', '0.12', '044-25874365', ''),
        ('A011', 'Ravi Kumar', 'Bangalore', '0.15', '077-45625874', ''),
        ('A010', 'Santakumar', 'Chennai', '0.14', '007-22388644', ''),
        ('A012', 'Lucida', 'San Jose', '0.12', '044-52981425', ''),
        ('A005', 'Anderson', 'Brisban', '0.13', '045-21447739', ''),
        ('A001', 'Subbarao', 'Bangalore', '0.14', '077-12346674', ''),
        ('A002', 'Mukesh', 'Mumbai', '0.11', '029-12358964', ''),
        ('A006', 'McDen', 'London', '0.15', '078-22255588', ''),
        ('A004', 'Ivan', 'Torento', '0.15', '008-22544166', ''),
        ('A009', 'Benjamin', 'Hampshair', '0.11', '008-22536178', '');
        "

    - name: Verify data insertion
      env:
        PGPASSWORD: postgres
      run: |
        psql -h localhost -U postgres -d testdb -c "SELECT * FROM public.agents;"
